<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asistan Pro V15</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root { --main-font: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; --accent: #6366f1; }
    body { font-family: var(--main-font); background: #f8fafc; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    .scroller-wrap { width: 760px; max-width: 96vw; text-align:center; }
    .scroller-window { height: 140px; display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(249,250,251,0.98)); box-shadow: 0 10px 30px rgba(2,6,23,0.08); border: 1px solid rgba(15,23,42,0.04); position:relative; }
    .name-wrapper { width: 100%; display:flex; align-items:center; justify-content:center; }
    .name-item { display:block; width: 88%; text-align: center; font-weight:800; font-size:32px; color:#0f172a; padding:10px 22px; border-radius:12px; transition: all 220ms ease; user-select:none; transform-origin:center; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    .name-item.dim { opacity:0.28; transform: scale(0.96); filter: blur(0.3px); }
    .name-item.active { transform: scale(1.18); color: #fff; padding: 14px 26px; border-radius: 12px; text-shadow: 0 8px 18px rgba(0,0,0,0.18); }

    .chart-container { height: 220px; }
    .nav-action { display:inline-flex; gap:8px; align-items:center; }
    .small-btn { padding:6px 10px; border-radius:8px; font-weight:700; font-size:13px; }
    .class-card { transition: transform .18s ease, box-shadow .18s ease; }
    .class-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 16px 40px rgba(2,6,23,0.12); }

    .timer-card { width: 520px; max-width: 92vw; background: linear-gradient(180deg,#ffffff, #fbfdff); border-radius: 18px; padding: 22px; box-shadow: 0 20px 40px rgba(99,102,241,0.08), inset 0 1px 0 rgba(255,255,255,0.6); border: 1px solid rgba(15,23,42,0.04); }
    .timer-center { width: 320px; height: 320px; display:flex; align-items:center; justify-content:center; margin: 0 auto; position: relative; }
    .timer-value { position:absolute; text-align:center; }
    .timer-value .big { font-size:58px; font-weight:800; letter-spacing: -2px; }
    .timer-value .small { font-size:14px; color:#64748b; margin-top:6px; }

    .quick-finger { background: #fff; padding: 12px; border-radius: 14px; box-shadow: 0 8px 24px rgba(2,6,23,0.06); display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .student-chip { padding:8px 12px; border-radius:12px; font-weight:700; display:inline-flex; gap:8px; align-items:center; }
    .student-chip .name { font-size:13px; }
    .student-chip .award { font-size:12px; padding:6px 8px; border-radius:8px; cursor:pointer; }

    .level-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; font-weight:800; font-size:12px; background: linear-gradient(90deg,#eef2ff,#fff); color:#334155; border:1px solid rgba(99,102,241,0.08); }
    .level-progress-mini { height:8px; width:140px; background:#eef2ff; border-radius:999px; overflow:hidden; }
    .level-progress-mini > i { display:block; height:100%; background:linear-gradient(90deg,#06b6d4,#6366f1); }

    /* V15: LEADERBOARD SCROLLER */
    .leaderboard-scroller { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: linear-gradient(90deg, #1e293b 0%, #4f46e5 50%, #1e293b 100%); color: white; display: flex; align-items: center; overflow: hidden; z-index: 998; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); }
    .leaderboard-scroller-content { display: flex; gap: 30px; padding: 0 20px; white-space: nowrap; animation: scrollLB 60s linear infinite; }
    @keyframes scrollLB { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    .leaderboard-item { display: inline-flex; gap: 12px; align-items: center; flex-shrink: 0; padding: 10px 18px; background: rgba(255,255,255,0.1); border-radius: 20px; backdrop-filter: blur(10px); font-weight: 700; }
    .leaderboard-rank { font-weight: 900; font-size: 18px; min-width: 32px; }
    .leaderboard-name { min-width: 130px; }
    .leaderboard-points { color: #fbbf24; font-weight: 800; }

    @media (max-width:900px) {
      .scroller-wrap { width: 92vw; }
      .scroller-window { height: 100px; }
      .name-item { font-size: 20px; }
      .name-item.active { transform: scale(1.12); }
      .timer-card { padding: 14px; }
      .timer-center { width: 260px; height: 260px; }
      .timer-value .big { font-size:42px; }
    }

    @media print { body { -webkit-print-color-adjust: exact; } }

    .toast-notice { position: fixed; left: 50%; top: 18px; transform: translateX(-50%); z-index: 9999; background: linear-gradient(90deg,#06b6d4,#6366f1); color: white; padding: 10px 14px; border-radius: 10px; font-weight:800; box-shadow:0 12px 34px rgba(2,6,23,0.12); }

    .exam-overlay { position: fixed; left: 50%; top: 12px; transform: translateX(-50%); z-index: 9999; background: linear-gradient(90deg,#06b6d4,#6366f1); color: white; padding: 18px 28px; border-radius: 14px; box-shadow: 0 20px 60px rgba(6,78,120,0.18); text-align: center; min-width: 420px; max-width: 96vw; }
    .exam-overlay .label { font-weight:800; font-size:18px; }
    .exam-overlay .time { font-weight:900; font-size:48px; margin-top:6px; }
    .exam-overlay .controls { margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }

    .timer-badge-global { display:none; }
  </style>
</head>
<body class="antialiased">
  <div id="root" class="min-h-screen pb-20"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // ==================== ICONS ====================
    const Icon = ({ children, className='', viewBox='0 0 24 24' }) =>
      <svg viewBox={viewBox} className={className} fill="none" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"><g>{children}</g></svg>;
    const Users = (p) => <Icon {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H11a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></Icon>;
    const FileText = (p) => <Icon {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></Icon>;
    const Sparkles = (p) => <Icon {...p}><path d="M12 2l1.5 3 3 1.5-3 1.5L12 11l-1.5-3L7 6.5 10 5z"/><path d="M5 14l.9 1.9L8 17l-1.1 1.1L6 20l-.9-1.9L4 17l1.1-1.1z"/></Icon>;
    const Plus = (p) => <Icon {...p}><path d="M12 5v14M5 12h14"/></Icon>;
    const Save = (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></Icon>;
    const Download = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
    const Upload = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 5 17 10"/><line x1="12" y1="5" x2="12" y2="21"/></Icon>;
    const Trophy = (p) => <Icon {...p}><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4h10v4a4 4 0 0 1-4 4H11a4 4 0 0 1-4-4V4z"/></Icon>;

    // ==================== HELPERS & STORAGE ====================
    const sanitize = (input) => { if (input == null) return ''; return String(input).replace(/[<>]/g,'').trim().slice(0,200); };
    const storage = {
      set: (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); return true; } catch(e){ console.error(e); return false; } },
      get: (k,d=null) => { try { const it = localStorage.getItem(k); return it ? JSON.parse(it) : d; } catch { return d; } },
      remove: (k) => { try { localStorage.removeItem(k); return true; } catch { return false; } }
    };
    const generateId = () => `${Date.now()}_${Math.random().toString(36).slice(2,9)}`;

    // ==================== V15: LEVEL SYSTEM (Her 25 Puan) ====================
    function getLevelFromPoints(points = 0) {
      const p = Math.max(0, Number(points || 0));
      return Math.floor(p / 25) + 1;
    }
    function getNextThreshold(points = 0) {
      const lvl = getLevelFromPoints(points);
      return lvl * 25;
    }
    function getProgressPercent(points = 0) {
      const p = Math.max(0, Number(points || 0));
      return Math.round((p % 25) / 25 * 100);
    }
    function avatarForLevel(level) {
      if (level <= 2) return 'ğŸ¥š';
      if (level <= 5) return 'ğŸ¥';
      if (level <= 15) return 'ğŸ”';
      if (level <= 25) return 'ğŸ›¡ï¸';
      return 'ğŸ‰';
    }

    // ==================== AUDIO ====================
    let sharedAudioCtx = null;
    function getAudioCtx() { if (sharedAudioCtx) return sharedAudioCtx; try { sharedAudioCtx = new (window.AudioContext || window.webkitAudioContext)(); return sharedAudioCtx; } catch { return null; } }
    function ensureAudioResume() { const ctx = getAudioCtx(); if (!ctx) return; if (ctx.state === 'suspended' && ctx.resume) ctx.resume().catch(()=>{}); }
    function playToneSequence(tones = []) {
      const ctx = getAudioCtx();
      if (!ctx) return;
      try {
        if (ctx.state === 'suspended' && ctx.resume) ctx.resume();
        let t0 = ctx.currentTime;
        tones.forEach(({freq, dur, type, vol, delay=0}) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = type || 'sine';
          o.frequency.setValueAtTime(freq, t0 + delay);
          g.gain.setValueAtTime(vol || 0.06, t0 + delay);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + delay + dur);
          o.connect(g); g.connect(ctx.destination);
          o.start(t0 + delay);
          o.stop(t0 + delay + dur + 0.02);
        });
      } catch (e) { }
    }
    const playTickSound = () => playToneSequence([{ freq: 420 + Math.random()*160, dur: 0.05, type: 'sine', vol: 0.03 }]);
    const playSpinStart = () => { ensureAudioResume(); playToneSequence([{ freq: 260, dur: 0.14, type:'triangle', vol:0.04 }]); };
    const playFinalSound = () => playToneSequence([{ freq: 980, dur:0.12, type:'triangle', vol:0.10 }, { freq: 720, dur:0.08, type:'triangle', vol:0.07, delay: 0.09 }]);
    const playPointSound = (amount) => { ensureAudioResume(); if (amount > 0) { playToneSequence([{ freq: 1200, dur: 0.10, type: 'triangle', vol: 0.10 }, { freq: 880, dur: 0.08, type: 'triangle', vol: 0.07, delay: 0.09 }]); } else if (amount < 0) { playToneSequence([{ freq: 140, dur: 0.18, type: 'sawtooth', vol: 0.08 }, { freq: 110, dur: 0.12, type: 'sawtooth', vol: 0.06, delay: 0.06 }]); } else { playToneSequence([{ freq: 520, dur: 0.06, type: 'sine', vol: 0.04 }]); } };
    const playLevelUpSound = () => { ensureAudioResume(); playToneSequence([{ freq: 880, dur: 0.18, type:'triangle', vol:0.10 }, { freq: 1200, dur: 0.12, type:'triangle', vol:0.08, delay:0.12 }]); };

    // ==================== PERSISTENT HOOK ====================
    const useLocalStorageState = (key, defaultValue) => {
      const [state, setState] = useState(() => {
        const v = storage.get(key, defaultValue);
        return v === null || v === undefined ? defaultValue : v;
      });
      useEffect(() => { storage.set(key, state); }, [key, state]);
      return [state, setState];
    };

    // ==================== V15: AUTO-BACKUP (30 Dakika) ====================
    function useAutoBackup(classes) {
      useEffect(() => {
        const interval = setInterval(() => {
          if (!classes || classes.length === 0) return;
          const data = { version: 15, created: new Date().toISOString(), classes, payload: {} };
          classes.forEach(c => {
            const students = storage.get(`s13_${c.id}`, []);
            const homeworks = storage.get(`h13_${c.id}`, []);
            const exams = storage.get(`e13_${c.id}`, []);
            const wheelData = storage.get(`wheel_${c.id}`, {});
            data.payload[c.id] = { students, homeworks, exams, wheelData };
          });
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `AsistanV15_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }, 30 * 60 * 1000);
        return () => clearInterval(interval);
      }, [classes]);
    }

    // ==================== ERROR BOUNDARY ====================
    function ErrorBoundary({children}) {
      const [hasError, setHasError] = useState(false);
      useEffect(() => {
        const h = (e) => { console.error(e); setHasError(true); };
        window.addEventListener('error', h);
        window.addEventListener('unhandledrejection', h);
        return () => { window.removeEventListener('error', h); window.removeEventListener('unhandledrejection', h); };
      }, []);
      if (hasError) return <div className="min-h-screen flex items-center justify-center p-6"><div className="bg-white p-8 rounded-2xl shadow"><h2 className="text-xl font-bold">Bir Hata OluÅŸtu</h2><p className="mt-3">SayfayÄ± yenileyin.</p><button className="mt-4 px-4 py-2 rounded bg-indigo-600 text-white" onClick={()=>window.location.reload()}>Yenile</button></div></div>;
      return children;
    }

    // ==================== BADGES (unchanged) ====================
    const BADGES = [
      { id: "streak_homework_3", name: "Ã‡alÄ±ÅŸkan BaÅŸlangÄ±Ã§", icon: "ğŸ“˜", description: "3 Ã¶dev Ã¼st Ã¼ste TAM yapan Ã¶ÄŸrenciye verilir.", trigger: "homework_streak", conditions: { type: "consecutive_homework", count: 3 }, points: 5 },
      { id: "streak_homework_7", name: "Ã–dev UstasÄ±", icon: "ğŸ“—", description: "7 Ã¶dev Ã¼st Ã¼ste TAM yapan Ã¶ÄŸrenciye verilir.", trigger: "homework_streak", conditions: { type: "consecutive_homework", count: 7 }, points: 15 },
      { id: "exam_improve_20", name: "AtÄ±lÄ±mcÄ±", icon: "ğŸš€", description: "Bir denemede Ã¶nceki denemeye gÃ¶re en az %20 artÄ±ÅŸ gÃ¶steren Ã¶ÄŸrenciye verilir.", trigger: "exam_improvement", conditions: { type: "relative_improvement_percent", percent: 20 }, points: 20 },
      { id: "wheel_selected_5", name: "ÅanslÄ± YÃ¼z", icon: "ğŸ¯", description: "Kura Ã§arkÄ±nda 5 kez seÃ§ilen Ã¶ÄŸrenciye verilir.", trigger: "wheel_selection", conditions: { type: "wheel_selected_count", count: 5 }, points: 8 },
      { id: "perfect_exam", name: "Kusursuz", icon: "ğŸ…", description: "Bir denemede maksimum nete yakÄ±n (%95 ve Ã¼zeri) sonuÃ§ elde eden Ã¶ÄŸrenciye verilir.", trigger: "exam_score", conditions: { type: "percent_of_total", percent: 95 }, points: 30 },
      { id: "silence_master", name: "Sessizlik Åampiyonu", icon: "ğŸ¤«", description: "SÄ±nÄ±f sessizliÄŸinde hedeflenen puanlara ulaÅŸÄ±lÄ±nca tÃ¼m sÄ±nÄ±fa verilebilir.", trigger: "silence_points", conditions: { type: "silence_points", points: 50 }, points: 10 },
      { id: "social_helper", name: "TakÄ±m Oyuncusu", icon: "ğŸ¤", description: "SÄ±nÄ±f iÃ§i yardÄ±mlaÅŸma iÃ§in.", trigger: "manual_or_behavior", conditions: { type: "manual_award", min_awards: 3 }, points: 12 },
      { id: "leader_board_top3", name: "Liderlik Rozeti", icon: "ğŸ‘‘", description: "Ay sonunda liderlik tablosunda ilk 3'e giren Ã¶ÄŸrenciye verilir.", trigger: "monthly_rank", conditions: { type: "top_n", n: 3 }, points: 25 },
      { id: "consistency_10weeks", name: "Ä°stikrar", icon: "ğŸ§­", description: "10 hafta boyunca sÄ±nÄ±f ortalamasÄ±nÄ±n Ã¼zerinde kalan Ã¶ÄŸrenciye verilir.", trigger: "long_term_consistency", conditions: { type: "weeks_above_class_avg", weeks: 10 }, points: 40 }
    ];

    // === BADGES PANEL (unchanged) ===
    function BadgesPanel({ badges = [], studentBadges = [], onInspect = () => {} }) {
      const earnedSet = new Set((studentBadges || []).map(b => (typeof b === 'string' ? b : b.id)));
      return (
        <div className="bg-white p-4 rounded-2xl shadow space-y-3">
          <h4 className="text-sm font-bold text-indigo-600">Rozetler & Unvanlar</h4>
          <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
            {badges.map(b => {
              const earned = earnedSet.has(b.id);
              return (
                <div key={b.id} className={`p-3 rounded-xl border ${earned ? 'bg-gradient-to-r from-indigo-600 to-cyan-500 text-white shadow-lg' : 'bg-slate-50'}`} title={b.description}>
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 flex items-center justify-center text-2xl">{b.icon || 'ğŸ…'}</div>
                    <div>
                      <div className="font-bold text-sm">{b.name}</div>
                      <div className="text-[11px] opacity-70">{earned ? 'Sahip' : 'Kilitli'}</div>
                    </div>
                  </div>
                  {!earned && (
                    <div className="mt-3">
                      <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                        <div className="h-2 bg-indigo-500" style={{ width: (b._progress||0) + '%' }} />
                      </div>
                      <div className="text-[11px] opacity-60 mt-1">{b.description}</div>
                    </div>
                  )}
                  <div className="mt-3 text-right">
                    <button onClick={() => onInspect(b)} className={`px-3 py-1 rounded-md text-xs font-bold ${earned ? 'bg-white/20 text-white' : 'bg-indigo-600 text-white'}`}>{earned ? 'GÃ¶ster' : 'NasÄ±l kazanÄ±lÄ±r?'}</button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // PART1 DEVAM EDECEK - PART2'YE GEÃ‡
     // ==================== SOUND METER (V15: Optional) ====================
    function SoundMeter({ threshold = 0.08, onAboveThreshold = () => {}, onBelowThreshold = () => {}, initialGain = 1.0, onClassSilenceIncrement = () => {} }) {
      const [permission, setPermission] = useState('idle');
      const [level, setLevel] = useState(0);
      const [gain, setGain] = useState(initialGain);
      const [silencePoints, setSilencePoints] = useState(0);
      const [enabled, setEnabled] = useState(false);
      const audioCtxRef = useRef(null);
      const analyserRef = useRef(null);
      const sourceRef = useRef(null);
      const gainNodeRef = useRef(null);
      const rafRef = useRef(null);

      useEffect(() => {
        if (!enabled) return;
        let mounted = true;
        async function start() {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            if (!mounted) return;
            setPermission('granted');
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioContext();
            audioCtxRef.current = ctx;
            const src = ctx.createMediaStreamSource(stream);
            sourceRef.current = src;
            const gainNode = ctx.createGain();
            gainNode.gain.value = gain;
            gainNodeRef.current = gainNode;
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 2048;
            analyserRef.current = analyser;
            src.connect(gainNode);
            gainNode.connect(analyser);
            const data = new Float32Array(analyser.fftSize);
            let belowSince = 0;
            function tick() {
              analyser.getFloatTimeDomainData(data);
              let sum = 0;
              for (let i=0;i<data.length;i++){ sum += data[i]*data[i]; }
              const rms = Math.sqrt(sum / data.length) * gain;
              const normalized = Math.min(1, rms * 4);
              setLevel(normalized);
              if (normalized >= threshold) {
                onAboveThreshold(normalized);
                belowSince = 0;
              } else {
                belowSince++;
                if (belowSince % 10 === 0) {
                  setSilencePoints(p => {
                    const nv = p + 1;
                    onClassSilenceIncrement(1);
                    onBelowThreshold(normalized);
                    return nv;
                  });
                }
              }
              rafRef.current = requestAnimationFrame(tick);
            }
            rafRef.current = requestAnimationFrame(tick);
          } catch (e) {
            console.error(e);
            setPermission('denied');
          }
        }
        start();
        return () => {
          mounted = false;
          if (rafRef.current) cancelAnimationFrame(rafRef.current);
          if (audioCtxRef.current && audioCtxRef.current.state !== 'closed') audioCtxRef.current.close().catch(()=>{});
        };
      }, [enabled]);

      useEffect(() => {
        try { if (gainNodeRef.current) gainNodeRef.current.gain.value = gain; } catch {}
      }, [gain]);

      if (!enabled) {
        return (
          <div className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-200 text-center">
            <div className="text-sm text-slate-600 mb-3">Ses Ã–lÃ§er <strong>KAPAL</strong></div>
            <button onClick={() => setEnabled(true)} className="px-4 py-2 bg-indigo-600 text-white rounded-md font-bold">EtkinleÅŸtir</button>
            <div className="text-xs text-slate-500 mt-2">(AkÄ±llÄ± tahtalarda mikrofon yoksa kapalÄ± bÄ±rakÄ±n)</div>
          </div>
        );
      }

      const levelColor = level > threshold ? '#ef4444' : level > threshold*0.6 ? '#f59e0b' : '#10b981';

      return (
        <div className="bg-white p-4 rounded-2xl shadow w-full max-w-md">
          <div className="flex items-center justify-between mb-2">
            <h5 className="font-bold text-sm">Ses Ã–lÃ§er</h5>
            <button onClick={() => setEnabled(false)} className="text-xs text-red-500 hover:text-red-700 font-bold">Kapat</button>
          </div>

          <div className="flex gap-4">
            <div style={{width:120, height:120, borderRadius:999, background:`radial-gradient(circle at 30% 30%, rgba(99,102,241,0.12), transparent), conic-gradient(${levelColor} ${level*360}deg, #e6e9ef 0deg)`}} className="flex items-center justify-center">
              <div className="text-center">
                <div className="text-2xl font-extrabold">{Math.round(level*100)}</div>
                <div className="text-[11px] text-slate-400">Seviye</div>
              </div>
            </div>

            <div className="flex-1">
              <div className="mb-3">
                <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                  <div style={{width:`${Math.min(100, level*100)}%`, height:'100%', background: levelColor}} />
                </div>
                <div className="text-[11px] mt-2">EÅŸik: {Math.round(threshold*100)}%</div>
              </div>

              <div className="mb-2">
                <label className="text-[11px]">Hassasiyet (Gain): {gain.toFixed(2)}</label>
                <input type="range" min="0.2" max="3" step="0.01" value={gain} onChange={(e)=>setGain(Number(e.target.value))} />
              </div>

              <div className="text-[12px] text-slate-600">
                Sessizlik PuanÄ±: <span className="font-bold text-indigo-600">{silencePoints}</span>
              </div>
            </div>
          </div>

          <div className="mt-3 flex gap-2">
            <button onClick={() => { setSilencePoints(0); }} className="px-3 py-1 bg-indigo-600 text-white rounded-md text-sm">SÄ±fÄ±rla Puan</button>
          </div>
        </div>
      );
    }

    // ==================== DAILY QUESTIONS ====================
    const QUESTIONS = [
      "DÃ¼nyanÄ±n en hÄ±zlÄ± karada koÅŸan hayvanÄ± hangisidir ve saatte yaklaÅŸÄ±k kaÃ§ km hÄ±z yapar?",
      "Bir mÄ±knatÄ±sÄ±n iki kutbu vardÄ±r. Neden mÄ±knatÄ±sÄ±n ortasÄ± genelde daha zayÄ±ftÄ±r?",
      "Ay neden bazen dolunay, bazen hilal gÃ¶rÃ¼nÃ¼r? KÄ±sa aÃ§Ä±kla.",
      "Bitkiler karbondioksidi nasÄ±l kullanÄ±r ve bu sÃ¼reÃ§ bize nasÄ±l fayda saÄŸlar?",
      "Pusula iÄŸnesi hangi Ã§ekim merkezine yÃ¶nelir ve bu neden Ã¶nemlidir?",
      "Atmosferin en dÄ±ÅŸ katmanÄ± uzayla aramÄ±zdaki ne tÃ¼r bir bariyer saÄŸlar?",
      "Bir metrenin kaÃ§ santimetre olduÄŸunu sÃ¶yle ve bir sÄ±nÄ±f boyutu Ã¶rneÄŸi ver.",
      "Bir kitabÄ±n arkasÄ±ndaki ISBN numarasÄ± ne iÅŸe yarar?",
      "Trafikte neden emniyet kemeri takmak Ã¶nemlidir? Fizikte hangi prensip bunu aÃ§Ä±klar?",
      "GÃ¼neÅŸ tutulmasÄ± ile ay tutulmasÄ± arasÄ±ndaki temel fark nedir?",
      "Bir su damlasÄ± neden yuvarlak olmaya meyillidir? YÃ¼zey gerilimi hakkÄ±nda kÄ±sa aÃ§Ä±klama.",
      "Tarihten: DÃ¼nya haritasÄ±nÄ± ilk doÄŸru oranlarla yapan keÅŸif hangisiydi ya da kim tarafÄ±ndan ileri sÃ¼rÃ¼ldÃ¼?",
      "Matematik: 15'i 3'e bÃ¶lÃ¼nce ne olur? Bu iÅŸlem gerÃ§ek hayat problemlerinde nasÄ±l kullanÄ±lÄ±r?",
      "Sanat: Bir tabloya baktÄ±ÄŸÄ±nda hangi Ã¼Ã§ detaya dikkat edersin (renk, Ä±ÅŸÄ±k, kompozisyon)?",
      "MÃ¼zik: Bir ÅŸarkÄ±nÄ±n temposu ne demektir ve nasÄ±l hissedilir?",
      "Teknoloji: Ä°nternete baÄŸlÄ± olmadÄ±ÄŸÄ±nda hangi cihazlar yine de Ã§alÄ±ÅŸÄ±r? Ã–rnek ver.",
      "DoÄŸa: Neden bazÄ± aÄŸaÃ§lar yaprak dÃ¶kerken bazÄ±larÄ± dÃ¶kmez? (Ä°ki neden sÃ¶yle)",
      "Fizik: Ses hÄ±zlÄ± mÄ± yavaÅŸ mÄ± hareket eder ve hangi ortamlarda daha hÄ±zlÄ± yayÄ±lÄ±r?",
      "CoÄŸrafya: Bir delta nedir ve nasÄ±l oluÅŸur?",
      "SaÄŸlÄ±k: GÃ¼n iÃ§inde su iÃ§menin iki Ã¶nemli faydasÄ±nÄ± sÃ¶yle."
    ];

    function FlashyTimer({ duration, onFinish, running, setRunning }) {
      const [timeLeft, setTimeLeft] = useState(duration);
      const rafRef = useRef(null);
      const pauseOffsetRef = useRef(0);

      useEffect(()=> {
        setTimeLeft(duration);
        pauseOffsetRef.current = 0;
      }, [duration]);

      useEffect(()=> {
        if (running) {
          const startMs = performance.now();
          function tick(now) {
            const elapsed = now - startMs + pauseOffsetRef.current*1000;
            const remaining = Math.max(0, duration - (elapsed/1000));
            setTimeLeft(remaining);
            if (remaining <= 0) {
              setRunning(false);
              onFinish && onFinish();
              playFinalSound();
              return;
            }
            rafRef.current = requestAnimationFrame(tick);
          }
          rafRef.current = requestAnimationFrame(tick);
        } else {
          if (rafRef.current) cancelAnimationFrame(rafRef.current);
        }
        return () => { if (rafRef.current) cancelAnimationFrame(rafRef.current); };
      }, [running]);

      const toggle = () => {
        if (running) {
          setRunning(false);
          pauseOffsetRef.current = duration - timeLeft;
        } else {
          setRunning(true);
        }
      };

      const reset = () => {
        setRunning(false);
        setTimeLeft(duration);
        pauseOffsetRef.current = 0;
      };

      const pct = Math.max(0, Math.min(1, (timeLeft / duration)));
      const mm = String(Math.floor(timeLeft/60)).padStart(2,'0');
      const ss = String(Math.floor(timeLeft%60)).padStart(2,'0');

      return (
        <div className="timer-card">
          <div className="flex items-center justify-between mb-3">
            <div>
              <div className="text-sm font-bold text-indigo-600">GÃœNÃœN SORUSU</div>
              <div className="text-xs text-slate-400">Hemen sor, sÄ±nÄ±fla paylaÅŸ, kronometreyi baÅŸlat.</div>
            </div>
            <div className="text-xs text-slate-500">SÃ¼re: <strong>{duration}s</strong></div>
          </div>

          <div className="timer-center">
            <svg width="320" height="320" viewBox="0 0 200 200" style={{position:'absolute'}}>
              <defs>
                <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stopColor="#06b6d4" />
                  <stop offset="50%" stopColor="#6366f1" />
                  <stop offset="100%" stopColor="#fb7185" />
                </linearGradient>
              </defs>
              <circle cx="100" cy="100" r="86" stroke="rgba(15,23,42,0.06)" strokeWidth="18" fill="none" />
              <circle cx="100" cy="100" r="86" stroke="url(#g1)" strokeWidth="10" strokeLinecap="round" fill="none"
                strokeDasharray={2*Math.PI*86}
                strokeDashoffset={(1-pct)*2*Math.PI*86}
                style={{ transition: running ? 'stroke-dashoffset 0.2s linear' : 'stroke-dashoffset 0.3s ease' }}
              />
              <circle cx="100" cy="100" r="60" stroke="rgba(99,102,241,0.07)" strokeWidth="12" fill="none" />
            </svg>

            <div className="timer-value">
              <div className="big">{mm}:{ss}</div>
              <div className="small">{Math.max(0, Math.ceil(timeLeft))} saniye kaldÄ±</div>
              <div style={{marginTop:12}}>
                <button onClick={toggle} className={`px-6 py-3 rounded-full font-bold text-white ${running ? 'bg-rose-500' : 'bg-indigo-600'}`} >
                  {running ? 'DURDUR' : 'BAÅLAT'}
                </button>
                <button onClick={reset} className="ml-3 px-4 py-2 rounded-full bg-slate-100 font-bold">SIFIRLA</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function DailyQuestions({ students = [], addLog = () => {} }) {
      const [idx, setIdx] = useState(0);
      const [duration, setDuration] = useState(30);
      const [running, setRunning] = useState(false);

      const next = () => setIdx(i => (i+1)%QUESTIONS.length);
      const prev = () => setIdx(i => (i-1+QUESTIONS.length)%QUESTIONS.length);

      const awardQuick = (studentId, amount) => {
        addLog(studentId, 'HIZLI', amount, `HÄ±zlÄ± Parmak: +${amount} P`);
        playPointSound(amount);
      };

      return (
        <div className="max-w-6xl mx-auto space-y-6">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
            <div className="lg:col-span-2">
              <div className="bg-white p-6 rounded-3xl shadow">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <div className="text-xs text-indigo-600 font-bold">GÃœNÃœN SORUSU</div>
                    <div className="text-sm text-slate-400">EÄŸlenceli ve dÃ¼ÅŸÃ¼ndÃ¼rÃ¼cÃ¼ â€” Ã¶ÄŸrencileri konuÅŸtur</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button onClick={prev} className="px-3 py-1 bg-slate-100 rounded">â—€</button>
                    <button onClick={next} className="px-3 py-1 bg-slate-100 rounded">â–¶</button>
                    <select value={duration} onChange={(e)=>setDuration(Number(e.target.value))} className="p-1 rounded bg-slate-50">
                      <option value={30}>30s</option>
                      <option value={45}>45s</option>
                      <option value={60}>60s</option>
                    </select>
                  </div>
                </div>

                <div className="mb-6">
                  <div className="text-2xl font-extrabold text-slate-800 mb-3">{QUESTIONS[idx]}</div>
                  <div className="text-xs text-slate-500 mb-2">Ã–ÄŸretmen sÃ¶zel olarak sorup kronometreyi baÅŸlatabilir veya ekrandan baÅŸlatabilirsiniz.</div>

                  <div className="flex justify-center mt-6">
                    <FlashyTimer duration={duration} onFinish={() => alert('SÃ¼re doldu!')} running={running} setRunning={setRunning} />
                  </div>
                </div>

                <div className="mt-6">
                  <div className="text-sm font-bold mb-2">AÃ§Ä±klama / Notlar (isteÄŸe baÄŸlÄ±)</div>
                  <textarea placeholder="KÄ±sa ipucu veya cevap notu..." className="w-full p-3 border rounded-xl min-h-[80px]" />
                </div>
              </div>
            </div>

            <aside>
              <div className="bg-white p-4 rounded-2xl shadow">
                <div className="text-sm font-bold text-indigo-600 mb-2">HAFTALIK SINIF RAPORU</div>
                <div className="text-xs text-slate-500 mb-3">KÄ±sa Ã¶zet ve haftalÄ±k puan liderleri</div>
                <div className="bg-indigo-50 p-3 rounded">
                  <div className="text-xs">Toplam Ã–dev</div>
                  <div className="text-lg font-bold">â€”</div>
                </div>
              </div>

              <div className="mt-4 bg-white p-4 rounded-2xl shadow">
                <div className="text-sm font-bold mb-3">HÄ±zlÄ± Parmak</div>
                <div className="quick-finger">
                  {students.length === 0 && <div className="text-xs text-slate-400">Ã–ÄŸrenci yok</div>}
                  {students.map((s, i) => (
                    <div key={s.id} className="student-chip" style={{ background: ['#fef3c7','#ede9fe','#ecfeff','#eef2ff'][i % 4] }}>
                      <div className="name">{s.name}</div>
                      <div>
                        <button onClick={() => awardQuick(s.id, 3)} className="award bg-indigo-600 text-white">+3</button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="text-xs text-slate-400 mt-3">HÄ±zlÄ± puan vermek iÃ§in isimlerin yanÄ±ndaki butonu kullan.</div>
              </div>
            </aside>
          </div>
        </div>
      );
    }

    // ==================== V15: LEADERBOARD SCROLLER ====================
    function LeaderboardScroller({ students = [] }) {
      const [displayData, setDisplayData] = useState([]);
      
      useEffect(() => {
        const sorted = [...students].sort((a,b) => (b.puan||0) - (a.puan||0)).slice(0, 15);
        setDisplayData(sorted);
        
        const interval = setInterval(() => {
          setDisplayData([...students].sort((a,b) => (b.puan||0) - (a.puan||0)).slice(0, 15));
        }, 5 * 60 * 1000);
        
        return () => clearInterval(interval);
      }, [students]);

      if (displayData.length === 0) return null;

      return (
        <div className="leaderboard-scroller">
          <div className="leaderboard-scroller-content">
            {displayData.map((s, i) => (
              <div key={s.id} className="leaderboard-item">
                <span className="leaderboard-rank">#{i + 1}</span>
                <span className="leaderboard-name">{s.name}</span>
                <span className="leaderboard-points">{s.puan || 0}P</span>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ==================== TAB COMPONENT ====================
    const Tab = ({active,onClick,icon:IconComp,label}) => (
      <button onClick={onClick} className={`flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs transition-all ${active ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-50'}`} aria-pressed={active}>
        <IconComp className="w-4 h-4" /> <span className="hidden sm:inline">{label}</span>
      </button>
    );

    // PART2 BITTI - PART3'E GEÃ‡
    // ==================== DASHBOARD ====================
    const Dashboard = ({ classes, onAddClass, onSelectClass, onDeleteClass }) => (
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-10">
        <button onClick={onAddClass} className="h-28 border-2 border-dashed border-slate-300 rounded-3xl font-bold text-slate-500 hover:text-indigo-600 hover:border-indigo-200 transition-all flex items-center justify-center gap-2 small-btn">
          <Plus className="w-5 h-5" /> Yeni SÄ±nÄ±f
        </button>
        {classes.map(c => (
          <div key={c.id} onClick={() => onSelectClass(c)} className="bg-white p-10 rounded-3xl shadow-xl border-b-8 border-indigo-600 hover:-translate-y-2 transition-all cursor-pointer relative group">
            <button onClick={(e)=>{ e.stopPropagation(); onDeleteClass(c.id); }} className="absolute top-5 right-5 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">ğŸ—‘</button>
            <h3 className="text-3xl font-extrabold text-slate-800">{c.name}</h3>
            <p className="mt-3 text-xs text-slate-400">TÄ±klayÄ±n â€” sÄ±nÄ±f detaylarÄ± iÃ§in</p>
          </div>
        ))}
      </div>
    );

    // ==================== STUDENT LIST (V15: Level Display) ====================
    const StudentList = ({ students, onAddStudent, onAddBulk, onDeleteStudent, levelFlashIds = [], onManualAdd }) => {
      const [name,setName] = useState(''); 
      const [bulkText,setBulkText] = useState(''); 
      const [showBulk,setShowBulk] = useState(false);
      
      const handleAdd = () => { 
        const cleaned = sanitize(name); 
        if (cleaned) { 
          onAddStudent(cleaned); 
          setName(''); 
        } 
      };
      
      const handleBulk = () => { 
        const names = bulkText.split('\n').map(l=>sanitize(l)).filter(Boolean); 
        if (names.length){ 
          onAddBulk(names); 
          setBulkText(''); 
          setShowBulk(false); 
        } 
      };
      
      return (
        <div className="bg-white rounded-3xl p-10 shadow-2xl">
          <div className="flex justify-between items-center mb-8 border-b pb-4">
            <h2 className="text-2xl font-bold flex items-center gap-2"><Users className="w-6 h-6" /> Ã–ÄŸrenci YÃ¶netimi</h2>
            <button onClick={()=>setShowBulk(!showBulk)} className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold text-xs flex items-center gap-2"><Plus className="w-4 h-4" /> {showBulk ? 'Tekil Ekle' : 'Toplu Ekle'}</button>
          </div>
          {showBulk ? (
            <div className="mb-8 space-y-4">
              <textarea value={bulkText} onChange={(e)=>setBulkText(e.target.value)} placeholder="Her satÄ±ra bir Ã¶ÄŸrenci adÄ± yazÄ±n..." className="w-full p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-indigo-500 min-h-[160px]" />
              <button onClick={handleBulk} className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold"><Save className="w-4 h-4 inline mr-2" /> Kaydet</button>
            </div>
          ) : (
            <div className="mb-8 flex gap-2">
              <input value={name} onChange={(e)=>setName(e.target.value)} onKeyPress={(e)=>e.key==='Enter' && handleAdd()} placeholder="Ã–ÄŸrenci adÄ±..." className="flex-1 p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-indigo-500" />
              <button onClick={handleAdd} className="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">Ekle</button>
            </div>
          )}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {students.map(s=>{
              const lvl = getLevelFromPoints(s.puan || 0);
              const progress = getProgressPercent(s.puan || 0);
              const flashing = Array.isArray(levelFlashIds) && levelFlashIds.includes(s.id);
              return (
              <div key={s.id} className={`p-4 bg-slate-50 rounded-xl border flex flex-col gap-2 text-xs ${flashing ? 'animate-pulse bg-yellow-50' : ''}`}>
                <div className="flex items-center justify-between">
                  <span className="truncate font-bold">{s.name}</span>
                  <div className="flex items-center gap-2">
                    <button onClick={()=>{ const v = parseInt(prompt('Manuel puan (Ã¶rn. +5 veya -3):','5'),10); if(!isNaN(v) && v!==0) onManualAdd && onManualAdd(s.id, v); }} className="text-indigo-600 bg-white px-2 py-1 rounded-md text-[12px] font-bold">Manuel</button>
                    <button onClick={()=>onDeleteStudent(s.id)} className="text-red-400 hover:text-red-600 ml-2" aria-label={`${s.name} sil`}>âœ–</button>
                  </div>
                </div>
                <div className="flex items-center justify-between">
                  <div className="level-badge"><span style={{fontSize:14}}>{avatarForLevel(lvl)}</span><span>Lv {lvl}</span></div>
                  <div className="text-xs text-slate-500">{s.puan || 0} P</div>
                </div>
                <div className="mt-2">
                  <div className="level-progress-mini"><i style={{width:`${progress}%`}} /></div>
                </div>
              </div>
            )})}
          </div>
          {students.length===0 && <div className="text-center py-12 text-slate-400"><Users className="w-16 h-16 mx-auto mb-4 opacity-20"/><p>HenÃ¼z Ã¶ÄŸrenci eklenmedi</p></div>}
        </div>
      );
    };

    // ==================== HOMEWORK MANAGER ====================
    const HomeworkManager = ({ students, homeworks, onSaveHomeworks, onAddLog }) => {
      const [hwTitle, setHwTitle] = useState('');
      const handleAddHomework = () => { 
        const t = sanitize(hwTitle); 
        if(t){ 
          onSaveHomeworks([...homeworks, { id: generateId(), title:t, results:{} }]); 
          setHwTitle(''); 
        } 
      };
      
      const handleBulkUpdate = (hwId, status) => {
        const hw = homeworks.find(h=>h.id===hwId); 
        const points = status==='done'?10:status==='partial'?5:0;
        students.forEach(s=>{ 
          const prev = hw.results?.[s.id] || 'none'; 
          const prevPoints = prev==='done'?10:prev==='partial'?5:0; 
          const diff = points - prevPoints; 
          if(diff!==0) onAddLog(s.id,'Ã–DEV',diff,hw.title); 
        });
        const newResults={}; 
        students.forEach(s=>newResults[s.id]=status); 
        onSaveHomeworks(homeworks.map(h=>h.id===hwId?{...h,results:newResults}:h));
      };
      
      const handleIndividualUpdate = (hwId,stdId,status) => { 
        const hw = homeworks.find(h=>h.id===hwId); 
        const prev = hw?.results?.[stdId]||'none'; 
        const points = status==='done'?10:status==='partial'?5:0; 
        const prevPoints = prev==='done'?10:prev==='partial'?5:0; 
        const diff = points - prevPoints; 
        if(diff!==0) onAddLog(stdId,'Ã–DEV',diff,hw.title); 
        onSaveHomeworks(homeworks.map(h=>h.id===hwId?{...h,results:{...h.results,[stdId]:status}}:h)); 
      };
      
      return (
        <div className="bg-white rounded-3xl p-10 shadow-2xl overflow-x-auto">
          <div className="flex justify-between items-center mb-8 border-b pb-4">
            <h2 className="text-2xl font-bold flex items-center gap-2"><FileText className="w-6 h-6" /> Ã–dev YÃ¶netimi</h2>
            <div className="flex gap-2">
              <input value={hwTitle} onChange={(e)=>setHwTitle(e.target.value)} placeholder="Ã–dev konusu..." className="p-2 border-2 border-slate-200 rounded-xl outline-none focus:border-indigo-500" />
              <button onClick={handleAddHomework} className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold"><Plus className="w-4 h-4" /></button>
            </div>
          </div>
          {homeworks.length > 0 ? (
            <table className="w-full">
              <thead><tr><th className="text-left pb-4 font-bold text-xs text-slate-400">Ã–ÄRENCÄ°</th>
                {homeworks.map(h=>(<th key={h.id} className="px-2"><div className="flex flex-col items-center gap-1 mb-4"><span className="text-[10px] font-bold text-indigo-600 mb-2">{h.title}</span><div className="flex gap-1"><button onClick={()=>handleBulkUpdate(h.id,'done')} className="text-[8px] bg-green-100 text-green-600 px-2 py-1 rounded font-bold">TAM</button><button onClick={()=>handleBulkUpdate(h.id,'partial')} className="text-[8px] bg-yellow-100 text-yellow-600 px-2 py-1 rounded font-bold">AZ</button><button onClick={()=>handleBulkUpdate(h.id,'none')} className="text-[8px] bg-red-100 text-red-600 px-2 py-1 rounded font-bold">YOK</button></div></div></th>))}
              </tr></thead>
              <tbody>{students.map(s=>(<tr key={s.id} className="border-t hover:bg-slate-50"><td className="py-3 text-xs font-bold">{s.name}</td>{homeworks.map(h=>(<td key={h.id} className="text-center"><div className="flex gap-1 justify-center">{['done','partial','none'].map(st=>(<button key={st} onClick={()=>handleIndividualUpdate(h.id,s.id,st)} className={`px-2 py-1 rounded-lg text-[8px] font-bold transition-all ${h.results?.[s.id]===st ? (st==='done'?'bg-green-500 text-white':st==='partial'?'bg-yellow-500 text-white':'bg-red-500 text-white') : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{st==='done'?'TAM':st==='partial'?'AZ':'YOK'}</button>))}</div></td>))}</tr>))}</tbody>
            </table>
          ) : (<div className="text-center py-12 text-slate-400"><FileText className="w-16 h-16 mx-auto mb-4 opacity-20" /><p>HenÃ¼z Ã¶dev eklenmedi</p></div>)}
        </div>
      );
    };

    // ==================== EXAM MANAGER ====================
    const ExamManager = ({ students, exams, onSaveExams, onStartExamTimer }) => {
      const [examTitle, setExamTitle] = useState(''); 
      const [examQCount, setExamQCount] = useState('');
      
      const handleAddExam = () => { 
        const title = sanitize(examTitle); 
        const qCount = parseInt(examQCount); 
        if (title && qCount>0) { 
          onSaveExams([...exams,{id:generateId(),title,qCount,results:{}}]); 
          setExamTitle(''); 
          setExamQCount(''); 
        } 
      };
      
      const handleUpdateResult = (examId,stdId,field,rawVal) => {
        const value = Math.max(0, Math.floor(Number(rawVal)||0));
        onSaveExams(exams.map(e=>{ 
          if(e.id===examId){ 
            const qCount=Number(e.qCount)||0; 
            const prev=e.results?.[stdId]||{d:0,y:0,net:0}; 
            const newD=field==='d'?value:prev.d; 
            const newY=field==='y'?value:prev.y; 
            if(newD+newY>qCount){ alert(`GeÃ§ersiz giriÅŸ: DoÄŸru+YanlÄ±ÅŸ toplamÄ± (${newD+newY}) soru sayÄ±sÄ±nÄ± (${qCount}) aÅŸÄ±yor.`); return e; } 
            const net=Math.max(0,newD-(newY/3)); 
            return {...e,results:{...e.results,[stdId]:{d:newD,y:newY,net}} } 
          } 
          return e; 
        }));
      };
      
      return (
        <div className="bg-white rounded-3xl p-10 shadow-2xl">
          <div className="flex justify-between items-center mb-8 border-b pb-4">
            <h2 className="text-2xl font-bold flex items-center gap-2"><FileText className="w-6 h-6" /> Deneme SÄ±navlarÄ±</h2>
            <div className="flex gap-2">
              <input value={examTitle} onChange={(e)=>setExamTitle(e.target.value)} placeholder="SÄ±nav konusu..." className="p-2 border-2 border-slate-200 rounded-xl outline-none focus:border-indigo-500" />
              <input type="number" value={examQCount} onChange={(e)=>setExamQCount(e.target.value)} placeholder="Soru sayÄ±sÄ±" className="w-32 p-2 border-2 border-slate-200 rounded-xl outline-none focus:border-indigo-500" min="1" />
              <button onClick={handleAddExam} className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold"><Plus className="w-4 h-4" /></button>
            </div>
          </div>
          <div className="space-y-6">
            {exams.map(e=>(
              <div key={e.id} className="p-6 bg-slate-50 rounded-3xl border">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-bold text-indigo-700">{e.title} <span className="text-slate-400 ml-2">({e.qCount} Soru)</span></h3>
                  <div className="flex gap-2">
                    <button onClick={()=>{
                      const m = parseInt(prompt('SÄ±nav iÃ§in sÃ¼re (dakika):', '45'),10);
                      if (!isNaN(m) && m>0) {
                        if (typeof onStartExamTimer === 'function') onStartExamTimer(e.id, e.title, m*60);
                      }
                    }} className="px-3 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold">ZamanlayÄ±cÄ± BaÅŸlat</button>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                  {students.map(s=>{ 
                    const cur = e.results?.[s.id] || { d:'', y:'', net:0 }; 
                    return (
                    <div key={s.id} className="bg-white p-3 rounded-xl border flex flex-col gap-2">
                      <span className="font-bold text-[10px] truncate">{s.name}</span>
                      <div className="flex gap-2">
                        <input type="number" placeholder="D" className="w-full p-2 border rounded-lg font-bold text-center text-xs focus:ring-2 focus:ring-indigo-500 outline-none" value={cur.d===''? '': cur.d} onChange={(ev)=>handleUpdateResult(e.id,s.id,'d',ev.target.value)} min="0" max={e.qCount} />
                        <input type="number" placeholder="Y" className="w-full p-2 border rounded-lg font-bold text-center text-xs focus:ring-2 focus:ring-indigo-500 outline-none" value={cur.y===''? '': cur.y} onChange={(ev)=>handleUpdateResult(e.id,s.id,'y',ev.target.value)} min="0" max={e.qCount} />
                      </div>
                      <div className="text-[9px] text-center font-bold text-indigo-400">NET: {( (e.results?.[s.id]?.net || 0) ).toFixed(2)}</div>
                    </div>
                  )})}
                </div>
              </div>
            ))}
            {exams.length===0 && <div className="text-center py-12 text-slate-400"><FileText className="w-16 h-16 mx-auto mb-4 opacity-20" /><p>HenÃ¼z sÄ±nav eklenmedi</p></div>}
          </div>
        </div>
      );
    };

    // ==================== NAME SCROLLER (KURA) ====================
    function NameScroller({ students, drawnStudents, onDraw, onReset, onAddLog, onRemoveStudent }) {
      const [isRunning, setIsRunning] = useState(false);
      const [displayName, setDisplayName] = useState('');
      const [highlightedId, setHighlightedId] = useState(null);

      const drawnSafe = Array.isArray(drawnStudents) ? drawnStudents : [];
      const available = Array.isArray(students) ? students.filter(s => !drawnSafe.includes(s.id)) : [];

      const tickIntervalRef = useRef(null);

      const startDraw = () => {
        if (available.length === 0) { alert('Ã‡ekilebilecek Ã¶ÄŸrenci yok.'); return; }
        ensureAudioResume();
        setIsRunning(true);
        setHighlightedId(null);
        playSpinStart();

        const totalTime = 4000;
        tickIntervalRef.current = setInterval(() => {
          playTickSound();
          const pick = available[Math.floor(Math.random() * available.length)];
          setDisplayName(pick.name);
        }, 70);

        setTimeout(() => {
          if (tickIntervalRef.current) { clearInterval(tickIntervalRef.current); tickIntervalRef.current = null; }
          const selected = available[Math.floor(Math.random() * available.length)];
          setDisplayName(selected.name);
          setHighlightedId(selected.id);
          try {
            if (typeof onDraw === 'function') onDraw(selected.id);
          } catch (e) {
            console.error('onDraw error', e);
          }
          playFinalSound();
          setIsRunning(false);
        }, totalTime);
      };

      const handleAward = (amount) => {
        if (!highlightedId) return;
        onAddLog && onAddLog(highlightedId, 'KURA', amount, 'Kura Ã–dÃ¼lÃ¼');
        playPointSound(amount);
      };

      const handleReset = () => {
        try {
          if (typeof onReset === 'function') onReset();
        } catch (e) {
          console.error('onReset threw', e);
        }
        try { setDisplayName(''); } catch {}
        try { setHighlightedId(null); } catch {}
      };

      return (
        <div className="bg-slate-900 rounded-3xl p-8 text-center shadow-2xl min-h-[560px] flex flex-col items-center gap-6 relative">
          <div className="text-indigo-300 font-bold uppercase mb-1 flex items-center gap-2"><Sparkles className="w-5 h-5" /> Åans (Ä°sim KaydÄ±rma)</div>

          <div className="scroller-wrap">
            <div className="scroller-window">
              <div className="name-wrapper">
                {displayName ? (
                  <div className={`name-item ${highlightedId ? 'active' : 'dim'}`} style={{ background: highlightedId ? 'linear-gradient(90deg,#06b6d4,#6366f1)' : 'transparent', color: highlightedId ? '#fff' : undefined }}>
                    {displayName}
                  </div>
                ) : (
                  <div className="name-item dim">HazÄ±r Bekliyor</div>
                )}
              </div>
            </div>

            <div className="mt-4 flex gap-3 items-center justify-center">
              <button onClick={startDraw} disabled={isRunning || available.length===0} className="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-2xl font-extrabold text-lg disabled:opacity-60 disabled:cursor-not-allowed">Ã‡EK!</button>
              <button onClick={handleReset} className="bg-slate-800 text-white px-4 py-3 rounded-2xl font-bold">SÄ±fÄ±rla</button>
            </div>

            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-white p-3 rounded-2xl shadow">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-xs text-slate-400">Ã‡ekilebilecek Ã–ÄŸrenciler</div>
                  <div className="text-xs text-slate-500">{available.length} / {Array.isArray(students) ? students.length : 0}</div>
                </div>
                <div className="flex flex-wrap gap-2 max-h-36 overflow-auto">
                  {available.map(s => (<div key={s.id} className="flex items-center gap-2 bg-indigo-50 px-2 py-1 rounded-full text-xs font-bold"><span>{s.name}</span></div>))}
                  {available.length===0 && <div className="text-xs text-slate-400">Yok</div>}
                </div>
              </div>

              <div className="bg-white p-3 rounded-2xl shadow text-center">
                <div className="text-xs text-slate-400 mb-2">Son Ã‡ekilen / Ä°ÅŸlemler</div>
                {highlightedId ? (
                  <>
                    <div className="text-2xl font-extrabold text-indigo-700 mb-3">{displayName}</div>
                    <div className="flex gap-2 justify-center flex-wrap">
                      {Array.from({length:11}).map((_, idx) => {
                        const v = idx - 5;
                        const isPos = v > 0;
                        return (
                          <button key={v} onClick={() => handleAward(v)} className={`w-12 h-12 ${isPos ? 'bg-emerald-500' : (v<0 ? 'bg-rose-500' : 'bg-indigo-500')} text-white rounded-xl font-extrabold text-lg shadow hover:scale-105 transition-transform`}>
                            {v > 0 ? `+${v}` : v}
                          </button>
                        );
                      })}
                      <button onClick={() => { if (confirm('Ã–ÄŸrenciyi listeden silmek istiyor musunuz?')) { onRemoveStudent && onRemoveStudent(highlightedId); setHighlightedId(null); setDisplayName(''); } }} className="w-14 h-12 bg-slate-300 text-slate-800 rounded-xl font-bold">Sil</button>
                    </div>
                  </>
                ) : (<div className="text-sm text-slate-500">HenÃ¼z seÃ§im yok</div>)}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ==================== STATS PAGE ====================
    const StatsPage = ({ students, exams, onShowDetail }) => {
      const calcAvg = (std) => {
        const results = exams.map(e => e.results?.[std.id]).filter(r => r && typeof r.net === 'number');
        if (!results.length) return 0;
        return results.reduce((s, r) => s + r.net, 0) / results.length;
      };
      const sorted = [...students].sort((a,b) => calcAvg(b) - calcAvg(a));
      return (
        <div className="space-y-4">
          <h2 className="text-center font-bold text-3xl mb-6 flex items-center justify-center gap-2"><Trophy className="w-8 h-8 text-indigo-600" /> BaÅŸarÄ± Analizi</h2>
          {sorted.map(s => {
            const avg = calcAvg(s).toFixed(2);
            const points = exams.map((e, i) => ({ x: i, y: Number(e.results?.[s.id]?.net || 0) }));
            const max = Math.max(1, ...points.map(p => p.y));
            const pathD = points.map((p, i) => `${i===0 ? 'M' : 'L'} ${i*28} ${60 - (p.y/max)*50}`).join(' ');
            return (
              <div key={s.id} onClick={() => onShowDetail(s)} className="bg-white p-6 rounded-3xl shadow-xl flex justify-between items-center border-l-8 border-indigo-600 cursor-pointer hover:bg-slate-50 transition-all">
                <div>
                  <div className="text-xl font-bold text-slate-700">{s.name}</div>
                  <div className="text-xs text-slate-400">Ort. Net: {avg}</div>
                </div>
                <div className="flex items-center gap-4">
                  <svg width="120" height="60" viewBox="0 0 300 80" className="bg-transparent">
                    <path d={pathD} fill="none" stroke="#6366f1" strokeWidth="3" strokeLinejoin="round" strokeLinecap="round" />
                  </svg>
                  <div className="bg-indigo-50 px-6 py-2 rounded-2xl text-center">
                    <p className="text-[9px] font-bold text-slate-400">Ortalama Net</p>
                    <p className="text-xl font-bold text-indigo-600">{avg}</p>
                  </div>
                </div>
              </div>
            );
          })}
          {students.length === 0 && <div className="text-center py-12 text-slate-400"><p>HenÃ¼z Ã¶ÄŸrenci yok</p></div>}
        </div>
      );
    };

    // PART3 BITTI - PART4'E GEÃ‡ (StudentDetail + Backup + App FonksiyonlarÄ±)
      // ==================== STUDENT DETAIL (V15: PDF + Reset/Restore) ====================
    const StudentDetail = ({ student, students, exams, onClose, onAddLog, onResetPoints, onRestorePoints }) => {
      const pointsCanvasRef = useRef(null);
      const examCanvasRef = useRef(null);
      const pointsChart = useRef(null);
      const examChart = useRef(null);
      const [manual, setManual] = useState('');

      const safeFormatDate = (d) => {
        if (!d) return '';
        try { const dt = new Date(d); if (!isNaN(dt.getTime())) return dt.toLocaleString('tr-TR'); } catch { }
        return String(d).slice(0,24);
      };

      useEffect(() => {
        const logs = (student.logs || []).slice().reverse();
        const labels = logs.map(l => {
          try { const dt = new Date(l.date); return (!isNaN(dt.getTime())) ? dt.toLocaleString('tr-TR') : String(l.date || '').slice(0,24); } catch { return String(l.date || '').slice(0,24); }
        });
        const data = logs.map(l => Number(l.currentTotal || 0));
        if (pointsChart.current) { try { pointsChart.current.destroy(); } catch{} pointsChart.current = null; }
        if (pointsCanvasRef.current) {
          pointsChart.current = new Chart(pointsCanvasRef.current, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Toplam Puan', data, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.08)', tension:0.3, pointRadius:4 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{ type:'category' }, y:{ beginAtZero:true } } }
          });
        }

        const classAvgForExam = (exam) => {
          const nets = (students || []).map(s=>Number(exam.results?.[s.id]?.net || 0));
          const valid = nets.filter(n => !isNaN(n));
          if (valid.length === 0) return 0;
          return valid.reduce((a,b)=>a+b,0) / valid.length;
        };
        const eLabels = exams.map(e => e.title || 'SÄ±nav');
        const studentData = exams.map(e => Number(e.results?.[student.id]?.net || 0));
        const classAvgs = exams.map(e => classAvgForExam(e));
        const studentColors = studentData.map((v,i) => (v < classAvgs[i] ? 'rgba(220,38,38,0.85)' : 'rgba(99,102,241,0.9)'));
        const classColors = classAvgs.map(_=>'rgba(148,163,184,0.4)');

        if (examChart.current) { try { examChart.current.destroy(); } catch{} examChart.current = null; }
        if (examCanvasRef.current) {
          examChart.current = new Chart(examCanvasRef.current, {
            type: 'bar',
            data: {
              labels: eLabels,
              datasets: [
                { label: student.name, data: studentData, backgroundColor: studentColors },
                { label: 'SÄ±nÄ±f OrtalamasÄ±', data: classAvgs, backgroundColor: classColors }
              ]
            },
            options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true } } }
          });
        }

        return () => {
          if (pointsChart.current) { try { pointsChart.current.destroy(); } catch{} pointsChart.current = null; }
          if (examChart.current) { try { examChart.current.destroy(); } catch{} examChart.current = null; }
        };
      }, [student, students, exams]);

      const handleAdd = () => {
        const v = parseInt(manual, 10);
        if (!isNaN(v) && v !== 0) { onAddLog(student.id, 'MANUEL', v, 'DÄ±ÅŸarÄ±dan GiriÅŸ'); setManual(''); }
      };

      const handleReset = () => {
        if (!confirm(`${student.name} iÃ§in puanlar sÄ±fÄ±rlanacak. OnaylÄ±yor musunuz?`)) return;
        onResetPoints && onResetPoints(student.id);
      };

      const handleRestore = () => {
        if (!confirm(`${student.name} iÃ§in daha Ã¶nce alÄ±nmÄ±ÅŸ sÄ±fÄ±rlama yedeÄŸi geri yÃ¼klenecekse onaylÄ±yor musunuz?`)) return;
        onRestorePoints && onRestorePoints(student.id);
      };

      const getChartImage = async (chartRef, fallbackCanvas) => {
        try {
          if (chartRef && chartRef.current && typeof chartRef.current.toBase64Image === 'function') return chartRef.current.toBase64Image();
        } catch {}
        const canvas = fallbackCanvas;
        if (!canvas) return null;
        for (let i=0;i<8;i++) {
          try { return canvas.toDataURL('image/png'); } catch(e) { await new Promise(r=>setTimeout(r,150)); }
        }
        return null;
      };

      const handlePrintReport = async () => {
        const pData = await getChartImage(pointsChart, pointsCanvasRef.current);
        const eData = await getChartImage(examChart, examCanvasRef.current);

        const reportHtml = `
          <!doctype html><html><head><meta charset="utf-8"><title>${student.name} - GeliÅŸim</title>
          <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
          <style>body{font-family:Poppins,system-ui;margin:20px;color:#0f172a} .card{background:#fff;border-radius:10px;padding:12px;margin-top:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)} h1{margin:0}</style></head><body>
          <h1>${student.name} â€” GeliÅŸim Karnesi</h1><div class="card"><strong>Toplam Puan:</strong> ${student.puan||0}</div>
          <div class="card"><strong>Puan Trendi</strong>${pData?`<img src="${pData}" style="max-width:100%;height:auto;margin-top:8px;border-radius:8px">`:'<div style="color:#64748b;margin-top:8px">Grafik yok</div>'}</div>
          <div class="card"><strong>Deneme PerformansÄ±</strong>${eData?`<img src="${eData}" style="max-width:100%;height:auto;margin-top:8px;border-radius:8px">`:'<div style="color:#64748b;margin-top:8px">Grafik yok</div>'}</div>
          <div class="card"><strong>Puan Hareketleri</strong><table style="width:100%;margin-top:8px;border-collapse:collapse">${(student.logs||[]).map(l=>`<tr><td style="padding:6px;border-bottom:1px solid #e6eef6">${(new Date(l.date)).toLocaleString('tr-TR')}</td><td style="padding:6px;border-bottom:1px solid #e6eef6">${l.reason}</td><td style="padding:6px;border-bottom:1px solid #e6eef6">${l.amount>0?`+${l.amount}`:l.amount} P</td></tr>`).join('')}</table></div>
          <div style="margin-top:12px"><button onclick="window.print()" style="padding:10px 14px;border-radius:8px;background:#6366f1;color:white;border:none;font-weight:700;cursor:pointer">YazdÄ±r / PDF</button></div>
          </body></html>
        `;
        const w = window.open('', '_blank', 'noopener,noreferrer');
        if (!w) { alert('Yeni pencere aÃ§ma engellendi. Pop-up izinlerini kontrol edin.'); return; }
        w.document.open();
        w.document.write(reportHtml);
        w.document.close();
        w.focus();
      };

      return (
        <div className="fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-sm flex items-start justify-center pt-12 p-4 overflow-y-auto" onClick={onClose}>
          <div className="bg-white w-full max-w-5xl rounded-3xl p-6 shadow-2xl relative" onClick={(e)=>e.stopPropagation()}>
            <div className="flex justify-between items-center mb-3">
              <h2 className="text-2xl font-bold">{student.name} <span className="text-indigo-600">GeliÅŸim Karnesi</span></h2>
              <div className="flex items-center gap-3">
                <button onClick={handlePrintReport} className="bg-indigo-600 text-white px-4 py-2 rounded-md font-bold">Raporu Ä°ndir / YazdÄ±r</button>
                <button onClick={handleReset} className="bg-rose-500 text-white px-4 py-2 rounded-md font-bold">SÄ±fÄ±rla Puan</button>
                <button onClick={handleRestore} className="bg-slate-100 text-slate-800 px-4 py-2 rounded-md font-bold">Geri Al</button>
                <button onClick={onClose} className="text-slate-400 hover:text-red-500 text-2xl">Ã—</button>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
              <div className="p-4 bg-slate-900 text-white rounded-2xl text-center">
                <div className="text-[10px] opacity-60 uppercase">TOPLAM PUAN</div>
                <div className="text-4xl font-extrabold">{student.puan||0} P</div>
                <div className="mt-2 level-badge"><span style={{fontSize:14}}>{avatarForLevel(getLevelFromPoints(student.puan||0))}</span><span>Lv {getLevelFromPoints(student.puan||0)}</span></div>
              </div>
              <div className="p-4 bg-indigo-50 rounded-2xl col-span-2">
                <div className="flex gap-2">
                  <input value={manual} onChange={(e)=>setManual(e.target.value)} className="w-full p-3 bg-white rounded-2xl text-center font-bold text-xl outline-none" placeholder="+ / -" />
                  <button onClick={handleAdd} className="bg-indigo-600 text-white px-6 rounded-2xl font-bold">EKLE</button>
                </div>
                <div className="mt-3 text-xs text-slate-500">Manuel puan ekle / Ã§Ä±kar</div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white p-4 rounded-2xl shadow chart-container">
                <h4 className="text-sm font-bold text-indigo-600 mb-3">Puan Trendi</h4>
                <div style={{height:'100%'}}><canvas ref={pointsCanvasRef} style={{width:'100%',height:'100%'}}/></div>
              </div>

              <div className="bg-white p-4 rounded-2xl shadow chart-container">
                <h4 className="text-sm font-bold text-indigo-600 mb-3">Deneme PerformansÄ± (Netler ve SÄ±nÄ±f OrtalamasÄ±)</h4>
                <div style={{height:'100%'}}><canvas ref={examCanvasRef} style={{width:'100%',height:'100%'}}/></div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
              <div className="bg-white p-3 rounded-2xl shadow">
                <h5 className="text-xs font-bold text-indigo-600 mb-2">Puan Hareketleri</h5>
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {(student.logs || []).map((l,i) => (
                    <div key={i} className="flex justify-between items-center p-2 rounded bg-slate-50 text-xs font-bold">
                      <div><div className="text-[10px] text-slate-400">{safeFormatDate(l.date)}</div>{l.reason}</div>
                      <div className={l.amount>0 ? 'text-emerald-500' : 'text-rose-500'}>{l.amount>0?`+${l.amount}`:l.amount} P</div>
                    </div>
                  ))}
                  {(student.logs || []).length === 0 && <p className="text-center text-slate-400">HenÃ¼z kayÄ±t yok</p>}
                </div>
              </div>

              <div className="bg-white p-3 rounded-2xl shadow">
                <h5 className="text-xs font-bold text-indigo-600 mb-2">Deneme Ã–zeti</h5>
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {exams.map(e => (
                    <div key={e.id} className="flex justify-between items-center p-2 rounded bg-slate-50 text-xs font-bold">
                      <div>{e.title}</div>
                      <div className="text-right">
                        <div className="text-slate-900">{(e.results?.[student.id]?.net || 0).toFixed(2)} Net</div>
                        <div className="text-orange-500 text-[11px]">%{(((e.results?.[student.id]?.net || 0) / e.qCount) * 100).toFixed(0)} BaÅŸarÄ±</div>
                      </div>
                    </div>
                  ))}
                  {exams.length === 0 && <p className="text-center text-slate-400">HenÃ¼z sÄ±nav yok</p>}
                </div>
              </div>
            </div>

            <div className="mt-6">
              <BadgesPanel badges={BADGES} studentBadges={(student.badges || []).map(b=> typeof b === 'string' ? b : b.id)} onInspect={(b)=>alert(`${b.name}\n\n${b.description}`)} />
            </div>

          </div>
        </div>
      );
    };

    // ==================== BACKUP UTILITIES ====================
    const makeBackup = (classes) => {
      const data = { version:15, created: new Date().toISOString(), classes, payload:{} };
      (classes || []).forEach(c => {
        const students = storage.get(`s13_${c.id}`, []);
        const homeworks = storage.get(`h13_${c.id}`, []);
        const exams = storage.get(`e13_${c.id}`, []);
        data.payload[c.id] = { students, homeworks, exams };
      });
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `asistanv15_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove();
      URL.revokeObjectURL(url);
    };

    const restoreFromBackupFile = async (file) => {
      try {
        const text = await file.text(); 
        const parsed = JSON.parse(text);
        if (!parsed || !parsed.classes) throw new Error('GeÃ§ersiz yedek dosyasÄ±');
        if (!confirm('Yedek yÃ¼klenirken mevcut veriler Ã¼zerine yazÄ±lacak. Devam edilsin mi?')) return { success:false, message:'KullanÄ±cÄ± iptal etti' };
        storage.set('ap_v13_classes', parsed.classes);
        parsed.classes.forEach(c => {
          const payload = parsed.payload?.[c.id] || { students:[], homeworks:[], exams:[] };
          storage.set(`s13_${c.id}`, payload.students || []);
          storage.set(`h13_${c.id}`, payload.homeworks || []);
          storage.set(`e13_${c.id}`, payload.exams || []);
        });
        return { success:true, parsed };
      } catch (e) { 
        console.error(e); 
        return { success:false, message: e.message || 'Hata' }; 
      }
    };

    // ==================== MAIN APP ====================
    function App() {
      const [page, setPage] = useState('dashboard');
      const [classes, setClasses] = useLocalStorageState('ap_v13_classes', []);
      const [selClass, setSelClass] = useState(null);
      const [students, setStudents] = useState([]);
      const [homeworks, setHomeworks] = useState([]);
      const [exams, setExams] = useState([]);
      const [drawnStudents, setDrawnStudents] = useState([]);
      const [detailStudent, setDetailStudent] = useState(null);
      const fileInputRef = useRef(null);

      const [levelFlashIds, setLevelFlashIds] = useState([]);
      const [examTimer, setExamTimer] = useLocalStorageState('exam_timer', { running:false, examId:'', label:'', remaining:0, paused:false, lastUpdated: Date.now(), classId: null });
      const [rankMode, setRankMode] = useState('weekly');

      useAutoBackup(classes);

      useEffect(()=> {
        if (selClass) {
          setStudents(storage.get(`s13_${selClass.id}`, []));
          setHomeworks(storage.get(`h13_${selClass.id}`, []));
          setExams(storage.get(`e13_${selClass.id}`, []));
          setDrawnStudents([]);
        } else { 
          setStudents([]); 
          setHomeworks([]); 
          setExams([]); 
          setDrawnStudents([]); 
        }
      }, [selClass]);

      const awardBadge = useCallback((studentId, badgeId) => {
        if (!selClass) return;
        setStudents(prev => {
          const updated = prev.map(s => {
            if (s.id === studentId) {
              const existing = (s.badges || []).map(b => typeof b === 'string' ? b : b.id);
              if (existing.includes(badgeId)) return s;
              const newBadges = [...(s.badges || []), { id: badgeId, earnedAt: new Date().toISOString() }];
              return { ...s, badges: newBadges };
            }
            return s;
          });
          storage.set(`s13_${selClass.id}`, updated);
          if (detailStudent?.id) {
            const ds = updated.find(x => x.id === detailStudent.id);
            if (ds) setDetailStudent(ds);
          }
          return updated;
        });
      }, [selClass, detailStudent]);

      const awardBadgeToAllStudents = useCallback((badgeId) => {
        if (!selClass) return;
        setStudents(prev => {
          const updated = prev.map(s => {
            const existing = (s.badges || []).map(b => typeof b === 'string' ? b : b.id);
            if (existing.includes(badgeId)) return s;
            return { ...s, badges: [...(s.badges||[]), { id: badgeId, earnedAt: new Date().toISOString() }] };
          });
          storage.set(`s13_${selClass.id}`, updated);
          return updated;
        });
      }, [selClass]);

      const computeHomeworkStreakForStudent = useCallback((studentId, count) => {
        if (!Array.isArray(homeworks) || homeworks.length === 0) return 0;
        const last = [...homeworks].slice(-count);
        let streak = 0;
        for (let i = last.length - 1; i >=0; i--) {
          const res = last[i].results?.[studentId];
          if (res === 'done') streak++; else break;
        }
        return streak;
      }, [homeworks]);

      const handleCheckHomeworkBadgesForStudent = useCallback((studentId) => {
        BADGES.filter(b => b.trigger === 'homework_streak').forEach(b => {
          const need = b.conditions.count;
          const streak = computeHomeworkStreakForStudent(studentId, need);
          if (streak >= need) awardBadge(studentId, b.id);
        });
      }, [computeHomeworkStreakForStudent, awardBadge]);

      const handleWheelSelected = useCallback((studentId) => {
        setStudents(prev => {
          const updated = prev.map(s => {
            if (s.id === studentId) {
              const wc = (s.wheelCount || 0) + 1;
              return { ...s, wheelCount: wc };
            }
            return s;
          });
          if (selClass) storage.set(`s13_${selClass.id}`, updated);
          updated.forEach(s => {
            if (s.id === studentId && (s.wheelCount || 0) >= 5) awardBadge(studentId, 'wheel_selected_5');
          });
          return updated;
        });
      }, [awardBadge, selClass]);

      const getWeeklyPointsForStudent = useCallback((s) => {
        if (!s || !Array.isArray(s.logs)) return 0;
        const now = Date.now();
        const weekAgo = now - (7 * 24 * 60 * 60 * 1000);
        return s.logs.reduce((sum, l) => {
          try {
            const t = new Date(l.date).getTime();
            if (!isNaN(t) && t >= weekAgo) return sum + Number(l.amount || 0);
          } catch(e){}
          return sum;
        }, 0);
      }, []);

      const addLog = useCallback((stdId, type, amount, reason) => {
        setStudents(prev => {
          const updated = prev.map(s => {
            if (s.id === stdId) {
              const oldP = Number(s.puan) || 0;
              const newP = oldP + Number(amount);
              const newLog = { date: new Date().toISOString(), type, amount: Number(amount), reason: sanitize(reason), currentTotal: newP };
              const oldLvl = getLevelFromPoints(oldP);
              const newLvl = getLevelFromPoints(newP);
              if (newLvl > oldLvl) {
                try { playLevelUpSound(); } catch {}
                setLevelFlashIds(prevIds => {
                  if (prevIds.includes(s.id)) return prevIds;
                  setTimeout(()=> setLevelFlashIds(ids => ids.filter(id => id !== s.id)), 2600);
                  return [...prevIds, s.id];
                });
              }
              return { ...s, puan:newP, logs: [ newLog, ...(s.logs || []) ] };
            }
            return s;
          });
          if (selClass) storage.set(`s13_${selClass.id}`, updated);
          if (detailStudent?.id === stdId) setDetailStudent(updated.find(x => x.id === stdId));
          try {
            if (type === 'Ã–DEV') {
              handleCheckHomeworkBadgesForStudent(stdId);
            }
          } catch (e) { console.error(e); }
          return updated;
        });
      }, [selClass, detailStudent, handleCheckHomeworkBadgesForStudent]);

      const saveStudents = useCallback((newStudents) => { 
        setStudents(newStudents); 
        if (selClass) storage.set(`s13_${selClass.id}`, newStudents); 
      }, [selClass]);

      const saveHomeworks = useCallback((newHomeworks) => {
        setHomeworks(newHomeworks); 
        if (selClass) storage.set(`h13_${selClass.id}`, newHomeworks);
        students.forEach(s => {
          BADGES.filter(b => b.trigger === 'homework_streak').forEach(b => {
            const need = b.conditions.count;
            const last = [...newHomeworks].slice(-need);
            let streak = 0;
            for (let i = last.length - 1; i >=0; i--) {
              const res = last[i].results?.[s.id];
              if (res === 'done') streak++; else break;
            }
            if (streak >= need) awardBadge(s.id, b.id);
          });
        });
      }, [selClass, students, awardBadge]);

      const saveExams = useCallback((newExams) => {
        setExams(newExams); 
        if (selClass) storage.set(`e13_${selClass.id}`, newExams);
        setTimeout(()=> {
          if (Array.isArray(newExams) && newExams.length > 0) {
            const lastExam = newExams[newExams.length-1];
            const prevExam = newExams[newExams.length-2];
            students.forEach(s => {
              const latestNet = Number(lastExam.results?.[s.id]?.net || 0);
              if (prevExam) {
                const prevNet = Number(prevExam.results?.[s.id]?.net || 0);
                if (prevNet > 0) {
                  const percent = ((latestNet - prevNet) / Math.abs(prevNet)) * 100;
                  if (percent >= 20) awardBadge(s.id, 'exam_improve_20');
                }
              }
              const qCount = Number(lastExam.qCount || 0);
              if (qCount > 0) {
                const percentOfTotal = (latestNet / qCount) * 100;
                if (percentOfTotal >= 95) awardBadge(s.id, 'perfect_exam');
              }
            });
          }
        }, 120);
      }, [selClass, students, awardBadge]);

      const handleAddClass = () => { 
        const name = prompt('SÄ±nÄ±f AdÄ±:'); 
        const cleaned = sanitize(name); 
        if (cleaned) { 
          setClasses([...classes, { id: generateId(), name: cleaned }]); 
        } 
      };

      const handleDeleteClass = (id) => { 
        if (!confirm('Bu sÄ±nÄ±f silinecek. Emin misiniz?')) return; 
        setClasses(classes.filter(c=>c.id!==id)); 
        storage.remove(`s13_${id}`); 
        storage.remove(`h13_${id}`); 
        storage.remove(`e13_${id}`); 
        if (selClass?.id===id) { 
          setSelClass(null); 
          setPage('dashboard'); 
        } 
      };

      const handleAddStudent = (name) => {
        const s = { id: generateId(), name, puan:0, logs:[], badges:[], wheelCount:0 };
        saveStudents([...students, s]);
      };

      const handleAddBulkStudents = (names) => {
        const newOnes = names.map(n=>({ id: generateId(), name:n, puan:0, logs:[], badges:[], wheelCount:0 }));
        saveStudents([...students, ...newOnes]);
      };

      const handleDeleteStudent = (id) => { 
        if (!confirm('Bu Ã¶ÄŸrenci silinecek. Emin misiniz?')) return; 
        saveStudents(students.filter(s=>s.id!==id)); 
      };

      const handleBackup = () => makeBackup(classes);
      const handleRestoreClick = () => fileInputRef.current?.click();
      const handleFileChange = async (ev) => {
        const file = ev.target.files?.[0]; 
        if (!file) return;
        const res = await restoreFromBackupFile(file);
        if (res.success) { 
          setClasses(res.parsed.classes); 
          if (res.parsed.classes.length>0) setSelClass(res.parsed.classes[0]); 
          alert('Yedek baÅŸarÄ±yla yÃ¼klendi.'); 
        } else { 
          alert('Yedek yÃ¼klenemedi: ' + (res.message || 'Hata')); 
        }
        ev.target.value = '';
      };

      const handleRemoveStudent = (id) => saveStudents(students.filter(s=>s.id!==id));

      const incrementClassSilencePoints = useCallback((amount = 1) => {
        if (!selClass) return;
        const key = `class_silence_${selClass.id}`;
        const cur = storage.get(key, 0) || 0;
        const nv = cur + amount;
        storage.set(key, nv);
        const silenceBadge = BADGES.find(b => b.id === 'silence_master');
        if (silenceBadge && nv >= (silenceBadge.conditions.points || 50)) {
          awardBadgeToAllStudents('silence_master');
          storage.set(key, 0);
          alert('Sessizlik hedefi aÅŸÄ±ldÄ± â€” tÃ¼m Ã¶ÄŸrencilere "Sessizlik Åampiyonu" rozetleri verildi!');
        }
      }, [selClass, awardBadgeToAllStudents]);

      useEffect(()=> {
        let id = null;
        if (examTimer && examTimer.running) {
          id = setInterval(()=> {
            setExamTimer(prev => {
              if (!prev || !prev.running) return prev;
              const now = Date.now();
              const elapsed = Math.round((now - (prev.lastUpdated || now)) / 1000);
              const remaining = Math.max(0, (prev.remaining || 0) - elapsed);
              if (remaining <= 0) {
                try { playFinalSound(); } catch {}
                alert(`${prev.label} sÄ±nav zamanlayÄ±cÄ±sÄ± bitti!`);
                return { running:false, examId:'', label:'', remaining:0, paused:false, lastUpdated: now, classId: null };
              }
              return { ...prev, remaining, lastUpdated: now };
            });
          }, 800);
        }
        return ()=> { if (id) clearInterval(id); };
      }, [examTimer && examTimer.running]);

      function startExamTimer(examId, label, seconds) {
        if (!selClass) { alert('Ã–nce sÄ±nÄ±f seÃ§in'); return; }
        setExamTimer({ running:true, examId, label, remaining: seconds, paused:false, lastUpdated: Date.now(), classId: selClass.id });
      }
      function pauseExamTimer() {
        setExamTimer(prev => {
          if (!prev || !prev.running) return prev;
          const now = Date.now();
          const elapsed = Math.round((now - (prev.lastUpdated || now)) / 1000);
          const newRemaining = Math.max(0, (prev.remaining || 0) - elapsed);
          return { ...prev, running:false, paused:true, remaining:newRemaining, lastUpdated: now };
        });
      }
      function resumeExamTimer() {
        setExamTimer(prev => {
          if (!prev || !prev.paused) return prev;
          return { ...prev, running:true, paused:false, lastUpdated: Date.now() };
        });
      }
      function stopExamTimer() {
        setExamTimer({ running:false, examId:'', label:'', remaining:0, paused:false, lastUpdated: Date.now(), classId: null });
      }
      const formatSec = (s) => { const m = String(Math.floor(s/60)).padStart(2,'0'); const sec = String(s%60).padStart(2,'0'); return `${m}:${sec}`; };

      const rankingData = useCallback(() => {
        if (!Array.isArray(students)) return [];
        if (rankMode === 'weekly') {
          return [...students].map(s => ({ ...s, weeklyPoints: getWeeklyPointsForStudent(s) }))
            .sort((a,b) => (b.weeklyPoints || 0) - (a.weeklyPoints || 0));
        }
        return [...students].sort((a,b) => (b.puan||0) - (a.puan||0));
      }, [students, rankMode, getWeeklyPointsForStudent]);

      function resetStudentPoints(studentId) {
        if (!selClass) return;
        const key = `reset_backup_${selClass.id}_${studentId}`;
        const cur = students.find(s => s.id === studentId);
        if (!cur) return;
        storage.set(key, cur);
        setStudents(prev => {
          const updated = prev.map(s => {
            if (s.id === studentId) {
              const oldP = Number(s.puan) || 0;
              const newLog = { date: new Date().toISOString(), type: 'SIFIRLAMA', amount: -oldP, reason: 'Puan sÄ±fÄ±rlama', currentTotal: 0 };
              return { ...s, puan: 0, logs: [ newLog, ...(s.logs || []) ] };
            }
            return s;
          });
          storage.set(`s13_${selClass.id}`, updated);
          if (detailStudent?.id === studentId) setDetailStudent(updated.find(x => x.id === studentId));
          return updated;
        });
      }
      function restoreStudentPoints(studentId) {
        if (!selClass) return;
        const key = `reset_backup_${selClass.id}_${studentId}`;
        const bak = storage.get(key, null);
        if (!bak) { alert('Geri alÄ±nacak bir yedek bulunamadÄ±.'); return; }
        setStudents(prev => {
          const updated = prev.map(s => s.id === studentId ? bak : s);
          storage.set(`s13_${selClass.id}`, updated);
          storage.remove(key);
          if (detailStudent?.id === studentId) setDetailStudent(updated.find(x => x.id === studentId));
          return updated;
        });
      }

      function resetClassPoints() {
        if (!selClass) return;
        if (!confirm(`TÃ¼m Ã¶ÄŸrencilerin puanlarÄ± sÄ±fÄ±rlanacak â€” ${selClass.name}. Devam edilsin mi?`)) return;
        const key = `reset_backup_class_${selClass.id}`;
        storage.set(key, students);
        setStudents(prev => {
          const updated = prev.map(s => {
            const oldP = Number(s.puan) || 0;
            const newLog = { date: new Date().toISOString(), type: 'SINIF_SIFIRLAMA', amount: -oldP, reason: 'SÄ±nÄ±f puan sÄ±fÄ±rlama', currentTotal: 0 };
            return { ...s, puan: 0, logs: [ newLog, ...(s.logs || []) ] };
          });
          storage.set(`s13_${selClass.id}`, updated);
          return updated;
        });
        alert('SÄ±nÄ±f puanlarÄ± sÄ±fÄ±rlandÄ± ve yedeklendi.');
      }
      function restoreClassPoints() {
        if (!selClass) return;
        const key = `reset_backup_class_${selClass.id}`;
        const bak = storage.get(key, null);
        if (!bak) { alert('SÄ±nÄ±f yedeÄŸi bulunamadÄ±.'); return; }
        if (!confirm('SÄ±nÄ±f yedeÄŸi geri yÃ¼klenecek. Mevcut puanlar Ã¼zerine yazÄ±lacak. OnaylÄ±yorsanÄ±z devam edin.')) return;
        setStudents(bak);
        storage.set(`s13_${selClass.id}`, bak);
        storage.remove(key);
        alert('SÄ±nÄ±f puanlarÄ± geri yÃ¼klendi.');
      }

      function manualAddForStudent(studentId, amount) {
        addLog(studentId, 'MANUEL', amount, 'HÄ±zlÄ± Manuel (Listeden)');
      }

      useEffect(()=> {
        if (!classes || classes.length === 0) {
          const sample = [{ id:'c_demo', name:'7-A' }];
          setClasses(sample);
          storage.set('ap_v13_classes', sample);
          const studs = [
            { id:'s1', name:'AyÅŸe', puan:95, logs:[], badges:[], wheelCount:0 },
            { id:'s2', name:'Emre', puan:120, logs:[], badges:[], wheelCount:0 },
            { id:'s3', name:'Zeynep', puan:215, logs:[], badges:[], wheelCount:0 }
          ];
          storage.set('s13_c_demo', studs);
        }
      }, []);

      return (
        <ErrorBoundary>
          <div className="min-h-screen">
            <nav className="bg-gradient-to-r from-slate-900 to-indigo-900 text-white p-4 flex justify-between items-center border-b-4 border-indigo-600">
              <div className="flex items-center gap-4">
                <h1 onClick={()=>{ setPage('dashboard'); setSelClass(null); }} className="text-xl font-bold cursor-pointer flex items-center gap-2">Asistan <span style={{color:'#a78bfa'}}>Pro V15</span></h1>
                <div className="hidden md:flex items-center gap-3 text-sm text-slate-200">
                  <span className="opacity-80">SÄ±nÄ±f: </span>
                  {selClass ? <span className="bg-indigo-600 px-3 py-1 rounded text-xs font-bold">{selClass.name}</span> : <span className="text-slate-400">HenÃ¼z seÃ§ili deÄŸil</span>}
                </div>
              </div>

              <div className="nav-action">
                <button onClick={handleBackup} title="Yedekle" className="bg-indigo-500 hover:bg-indigo-400 small-btn text-white flex items-center gap-2"><Download className="w-4 h-4" /> Yedekle</button>
                <button onClick={handleRestoreClick} title="Yedekten YÃ¼kle" className="bg-white/10 hover:bg-white/20 small-btn text-white flex items-center gap-2"><Upload className="w-4 h-4" /> YÃ¼kle</button>
                <input ref={fileInputRef} type="file" accept="application/json" onChange={handleFileChange} className="hidden" />
              </div>
            </nav>

            <main className="p-6 max-w-7xl mx-auto">
              {page==='dashboard' && <Dashboard classes={classes} onAddClass={handleAddClass} onSelectClass={(c)=>{ setSelClass(c); setPage('list'); }} onDeleteClass={handleDeleteClass} />}

              {selClass && (
                <>
                  <div className="flex flex-wrap gap-2 p-2 bg-white rounded-2xl w-fit shadow-sm border mx-auto md:mx-0 mb-6">
                    <button className={`px-3 py-2 rounded-xl font-bold text-xs ${page==='list' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`} onClick={()=>setPage('list')}>Ã–ÄŸrenci</button>
                    <button className={`px-3 py-2 rounded-xl font-bold text-xs ${page==='hw' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`} onClick={()=>setPage('hw')}>Ã–dev</button>
                    <button className={`px-3 py-2 rounded-xl font-bold text-xs ${page==='wheel' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`} onClick={()=>setPage('wheel')}>Kura</button>
                    <button className={`px-3 py-2 rounded-xl font-bold text-xs ${page==='exam' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`} onClick={()=>setPage('exam')}>SÄ±nav</button>
                    <button className={`px-3 py-2 rounded-xl font-bold text-xs ${page==='stats' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`} onClick={()=>setPage('stats')}>Analiz</button>
                    <button className={`px-3 py-2 rounded-xl font-bold text-xs ${page==='rank' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`} onClick={()=>setPage('rank')}>Liderlik</button>
                    <button className={`px-3 py-2 rounded-xl font-bold text-xs ${page==='daily' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`} onClick={()=>setPage('daily')}>GÃ¼nÃ¼n Sorusu</button>
                    <button className={`px-3 py-2 rounded-xl font-bold text-xs ${page==='tools' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`} onClick={()=>setPage('tools')}>AraÃ§lar</button>
                  </div>

                  {page==='list' && <StudentList students={students} onAddStudent={handleAddStudent} onAddBulk={handleAddBulkStudents} onDeleteStudent={handleDeleteStudent} levelFlashIds={levelFlashIds} onManualAdd={manualAddForStudent} />}

                  {page==='hw' && <HomeworkManager students={students} homeworks={homeworks} onSaveHomeworks={saveHomeworks} onAddLog={addLog} />}

                  {page==='wheel' && <NameScroller students={students} drawnStudents={drawnStudents} onDraw={(id)=>{ setDrawnStudents(prev=>[...prev, id]); handleWheelSelected(id); }} onReset={()=>setDrawnStudents([])} onAddLog={addLog} onRemoveStudent={handleRemoveStudent} />}

                  {page==='exam' && <ExamManager students={students} exams={exams} onSaveExams={saveExams} onStartExamTimer={startExamTimer} />}

                  {page==='stats' && <StatsPage students={students} exams={exams} onShowDetail={setDetailStudent} />}

                  {page==='rank' && (
                    <div className="max-w-4xl mx-auto space-y-4 pt-10">
                      <div className="flex items-center justify-between mb-4">
                        <h2 className="text-3xl font-bold">Liderlik Tablosu</h2>
                        <div className="flex items-center gap-2">
                          <button onClick={()=>setRankMode('weekly')} className={`px-3 py-1 rounded ${rankMode==='weekly' ? 'bg-indigo-600 text-white' : 'bg-slate-100'}`}>HaftalÄ±k</button>
                          <button onClick={()=>setRankMode('all')} className={`px-3 py-1 rounded ${rankMode==='all' ? 'bg-indigo-600 text-white' : 'bg-slate-100'}`}>Genel</button>
                        </div>
                      </div>

                      <div className="space-y-3">
                        {rankingData().map((s,i) => (
                          <div key={s.id} onClick={()=>setDetailStudent(s)} className="bg-white p-4 rounded-2xl shadow flex items-center justify-between cursor-pointer hover:scale-[1.01] transition-all">
                            <div className="flex items-center gap-4">
                              <div className="text-2xl font-extrabold text-slate-400">#{i+1}</div>
                              <div>
                                <div className="font-bold text-slate-700">{s.name}</div>
                                <div className="text-xs text-slate-400">{s.badges?.length || 0} rozet â€¢ Lv {getLevelFromPoints(s.puan||0)}</div>
                              </div>
                            </div>
                            <div className="text-right">
                              {rankMode === 'weekly' ? <div className="text-2xl font-bold text-indigo-600">{getWeeklyPointsForStudent(s)} P</div> : <div className="text-2xl font-bold text-indigo-600">{s.puan || 0} P</div>}
                              <div className="text-xs text-slate-400">{rankMode === 'weekly' ? 'Son 7 gÃ¼n' : 'Genel'}</div>
                            </div>
                          </div>
                        ))}
                        {students.length === 0 && <div className="text-center py-12 text-slate-400"><p>HenÃ¼z Ã¶ÄŸrenci yok</p></div>}
                      </div>
                    </div>
                  )}

                  {page==='daily' && <DailyQuestions students={students} addLog={addLog} />}

                  {page==='tools' && (
                    <div className="max-w-3xl mx-auto space-y-6">
                      <div className="text-center text-slate-700 font-bold mb-2">SÄ±nÄ±f Ses Ã–lÃ§er (Sessizlik PuanlarÄ±)</div>
                      <SoundMeter threshold={0.08} initialGain={1.0} onAboveThreshold={(lvl)=>{ }} onBelowThreshold={(lvl)=>{ }} onClassSilenceIncrement={(amt) => { incrementClassSilencePoints(amt); }} />
                      <div className="text-sm text-slate-500 mt-2">Sessizlik PuanlarÄ± sÄ±nÄ±f bazÄ±nda toplanÄ±r; hedefe ulaÅŸtÄ±ÄŸÄ±nda rozetler sÄ±nÄ±fa verilir.</div>

                      <div className="bg-white p-4 rounded-2xl shadow">
                        <h4 className="text-sm font-bold text-indigo-600">Puan YÃ¶netimi (SÄ±nÄ±f / Bireysel)</h4>
                        <div className="mt-3 text-sm text-slate-600">Buradan tÃ¼m sÄ±nÄ±fÄ±n puanlarÄ±nÄ± sÄ±fÄ±rlayabilir veya Ã¶nceden alÄ±nmÄ±ÅŸ sÄ±nÄ±f yedeÄŸini geri yÃ¼kleyebilirsiniz. AyrÄ±ca sÄ±nÄ±f iÃ§indeki bireysel yedeklerin de yÃ¶netimi StudentDetail iÃ§inden yapÄ±lÄ±r.</div>
                        <div className="mt-4 flex gap-3">
                          <button onClick={resetClassPoints} className="px-4 py-2 bg-rose-500 text-white rounded-md font-bold">SÄ±nÄ±fÄ± SÄ±fÄ±rla (Yedekle)</button>
                          <button onClick={restoreClassPoints} className="px-4 py-2 bg-indigo-600 text-white rounded-md font-bold">SÄ±nÄ±fÄ± Geri YÃ¼kle</button>
                        </div>
                        <div className="mt-3 text-xs text-slate-400">Not: SÄ±fÄ±rlama iÅŸleminden Ã¶nce mevcut Ã¶ÄŸrenci verileri localStorage'a yedeklenir.</div>
                      </div>
                    </div>
                  )}
                </>
              )}
            </main>

            {detailStudent && <StudentDetail student={detailStudent} students={students} exams={exams} onClose={()=>setDetailStudent(null)} onAddLog={addLog} onResetPoints={resetStudentPoints} onRestorePoints={restoreStudentPoints} />}

            {examTimer && (examTimer.running || examTimer.paused) && examTimer.classId === (selClass && selClass.id) && (
              <div className="exam-overlay" role="status" aria-live="polite">
                <div className="label">{examTimer.label} â€” SÄ±nav</div>
                <div className="time">{formatSec(examTimer.remaining)}</div>
                <div className="controls">
                  {examTimer.running ? (
                    <button onClick={pauseExamTimer} className="px-3 py-1 rounded-md bg-white text-indigo-700 font-bold">Duraklat</button>
                  ) : (
                    <button onClick={resumeExamTimer} className="px-3 py-1 rounded-md bg-white text-indigo-700 font-bold">SÃ¼rdÃ¼r</button>
                  )}
                  <button onClick={stopExamTimer} className="px-3 py-1 rounded-md bg-rose-500 text-white font-bold">Durdur</button>
                </div>
              </div>
            )}

            <LeaderboardScroller students={students} />
          </div>
        </ErrorBoundary>
      );
    }

    // ==================== START ====================
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
